
multi_cooperate_network_agent_archæ˜¯æ™ºèƒ½ä½“ååŒçš„
çœŸæ­£çš„æ‰§è¡Œé¡ºåºï¼ˆé€æ­¥ã€é€è¡Œã€æŒ‰æ—¶é—´ï¼‰

ä¸‹é¢æˆ‘æŒ‰ä½ è¿™æ¬¡è¿è¡Œçš„çœŸå®æ—¥å¿—é¡ºåºæ¥è§£é‡Šã€‚

Step 0ï¸âƒ£ å…¥å£ï¼ˆEntry Pointï¼‰
work_flow.set_entry_point("db_manager")


ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä¸€å®šæ˜¯ï¼š

db_manager


å¹¶ä¸”å®ƒæ‹¿åˆ°çš„ state æ˜¯ï¼š

{
  "messages": [
      HumanMessage("æ ¹æ®sales_idä½¿ç”¨æŠ˜çº¿å›¾æ˜¾ç¤ºå‰5åé”€å”®çš„é”€å”®æ€»é¢")
  ]
}

Step 1ï¸âƒ£ db_manager ç¬¬ä¸€æ¬¡æ‰§è¡Œ
æ‰§è¡Œçš„æ˜¯ï¼š
db_node = agent_node(agent=db_agent, name="db_manager")


db_manager çš„ LLM çœ‹åˆ°äº†ï¼š

system promptï¼ˆåªèƒ½æä¾›æ•°æ®ï¼‰

HumanMessageï¼ˆç”¨æˆ·éœ€æ±‚ï¼‰

LLM çš„å†³ç­–ï¼š

â€œæˆ‘è¦å…ˆæŸ¥æ•°æ®â€

äºæ˜¯å®ƒè¿”å›çš„æ˜¯ï¼š

AIMessage(
  tool_calls=[{
      name: "query_sales",
      args: {"count": 5}
  }]
)


âš ï¸ æ³¨æ„ï¼š
æ­¤æ—¶ query_sales è¿˜æ²¡æ‰§è¡Œ

Step 2ï¸âƒ£ router åˆ¤æ–­èµ°å‘
def router(state):
    last_message = state["messages"][-1]
    if last_message.tool_calls:
        return "call_tool"


âœ” å› ä¸º å­˜åœ¨ tool_calls

æ‰€ä»¥èµ°å‘ï¼š

db_manager â†’ call_tool

Step 3ï¸âƒ£ call_tool æ‰§è¡Œ query_sales
tool_executor = ToolNode(tools)


LangGraph è‡ªåŠ¨åšä¸‰ä»¶äº‹ï¼š

æ‰¾åˆ° query_sales

æ‰§è¡Œï¼š

query_sales(count=5)


æŠŠç»“æœåŒ…è£…æˆï¼š

ToolMessage(
  name="query_sales",
  content='[...]'
)


å¹¶ä¸” state å˜æˆï¼š

messages = [
  HumanMessage,
  AIMessage(tool_calls=query_sales),
  ToolMessage(query_salesç»“æœ)
]


âš ï¸ æ³¨æ„ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ï¼š

ToolMessage åªæ˜¯â€œæ‰§è¡Œç»“æœâ€ï¼Œ
è¿˜æ²¡æœ‰ä»»ä½• Agent è§£è¯»å®ƒ

Step 4ï¸âƒ£ call_tool â†’ å›åˆ°è°ï¼Ÿ
work_flow.add_conditional_edges(
    "call_tool",
    lambda x: x["sender"],
    {
        "db_manager": "db_manager",
        "code_generator": "code_generator"
    }
)


è¿™é‡Œçš„ sender æ˜¯è°ï¼Ÿ

sender = "db_manager"


å› ä¸ºï¼š

query_sales æ˜¯ db_manager å‘èµ·çš„

ğŸ‘‰ æ‰€ä»¥ï¼š

call_tool â†’ db_manager

Step 5ï¸âƒ£ db_manager ç¬¬äºŒæ¬¡æ‰§è¡Œï¼ˆå…³é”®ï¼‰

è¿™æ¬¡ db_manager æ”¶åˆ°çš„ messages æ˜¯ï¼š

HumanMessage
AIMessage(tool_calls=query_sales)
ToolMessage(query_sales è¿”å›çš„æ•°æ®)


ç°åœ¨å®ƒç»ˆäºâ€œçœ‹åˆ°äº†çœŸå®æ•°æ®â€ã€‚

æ­£ç¡®æƒ…å†µä¸‹ï¼Œå®ƒåº”è¯¥åšçš„æ˜¯ï¼š

â€œæ•°æ®å‡†å¤‡å¥½äº†ï¼Œäº¤ç»™ code_generator ç”»å›¾â€

äºæ˜¯å®ƒè¿”å›ä¸€ä¸ª ä¸å¸¦ tool_calls çš„ AIMessage
AIMessage(
  content="æ•°æ®å·²æŸ¥è¯¢å®Œæˆï¼Œè¯·è¿›è¡Œå¯è§†åŒ–"
)

Step 6ï¸âƒ£ router å†æ¬¡åˆ¤æ–­
if last_message.tool_calls:
    return "call_tool"
if "FINAL ANSWER" in last_message.content:
    return END
return "continue"


è¿™æ¬¡ï¼š

âŒ æ²¡æœ‰ tool_calls

âŒ æ²¡æœ‰ FINAL ANSWER

æ‰€ä»¥ï¼š

return "continue"


è€Œåœ¨ db_manager çš„ conditional_edges ä¸­ï¼š

{"continue": "code_generator"}


ğŸ‘‰ è·³è½¬åˆ°ï¼š

code_generator

Step 7ï¸âƒ£ code_generator ç¬¬ä¸€æ¬¡æ‰§è¡Œ

code_generator LLM çœ‹åˆ°çš„ messages æ˜¯ï¼š

Human
db_manager(tool_calls)
ToolMessage(query_sales æ•°æ®)
db_manager(è¯´æ˜æ•°æ®å·²å°±ç»ª)


å®ƒçš„ system prompt æ˜¯ï¼š

Run python code to display diagrams or output execution results.

å®ƒçš„åˆ¤æ–­ï¼š

â€œæˆ‘è¯¥ç”»æŠ˜çº¿å›¾äº†â€

äºæ˜¯å®ƒè¿”å›ï¼š

AIMessage(
  tool_calls=[{
      name: "python_repl",
      args: { code: "import matplotlib..." }
  }]
)

Step 8ï¸âƒ£ router â†’ call_toolï¼ˆç¬¬äºŒæ¬¡ï¼‰

åŒæ ·çš„é€»è¾‘ï¼š

code_generator â†’ call_tool

Step 9ï¸âƒ£ call_tool æ‰§è¡Œ python_repl

LangGraphï¼š

æ‰¾åˆ° python_repl

æ‰§è¡Œä»£ç 

è¿”å›ï¼š

ToolMessage(
  name="python_repl",
  content="Successfully executed / Error"
)


å¹¶æ›´æ–° state.messages

Step ğŸ”Ÿ call_tool â†’ å›åˆ° code_generator

å› ä¸ºï¼š

sender = "code_generator"


æ‰€ä»¥ï¼š

call_tool â†’ code_generator

Step 11ï¸âƒ£ code_generator æœ€åä¸€æ¬¡æ‰§è¡Œ

ç°åœ¨ code_generator çœ‹åˆ°äº†ï¼š

ç”»å›¾æ˜¯å¦æˆåŠŸ

python_repl çš„ stdout / error

å¦‚æœæˆåŠŸï¼š
AIMessage(
  content="FINAL ANSWER: æŠ˜çº¿å›¾å·²ç”Ÿæˆ"
)

Step 12ï¸âƒ£ router è¯†åˆ« FINAL ANSWER â†’ END
if "FINAL ANSWER" in last_message.content:
    return END


ğŸ‰ æ•´ä¸ªæµç¨‹ç»“æŸ

å›¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Human   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚  "æ ¹æ®sales_idä½¿ç”¨æŠ˜çº¿å›¾æ˜¾ç¤ºå‰5åé”€å”®çš„é”€å”®æ€»é¢"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ db_manager   â”‚  â† Entry Point
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  å†³å®šè°ƒç”¨ query_sales
     â”‚  (tool_calls)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  call_tool   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  æ‰§è¡Œ query_sales(count=5)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ query_sales  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  è¿”å› ToolMessage(JSONæ•°æ®)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  call_tool   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  sender = db_manager
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ db_manager   â”‚  â† ç¬¬äºŒæ¬¡æ‰§è¡Œ
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  è¯»å– ToolMessage
     â”‚  â€œæ•°æ®å·²å‡†å¤‡å¥½â€
     â”‚  ï¼ˆæ—  tool_callsï¼‰
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ router       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  continue
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ code_generatorâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  å†³å®šç”»æŠ˜çº¿å›¾
     â”‚  (tool_calls: python_repl)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  call_tool   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  æ‰§è¡Œ python_repl(matplotlib)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ python_repl  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  è¿”å› ToolMessage(æ‰§è¡Œç»“æœ)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  call_tool   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  sender = code_generator
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ code_generatorâ”‚  â† ç¬¬äºŒæ¬¡æ‰§è¡Œ
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚  FINAL ANSWER
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     END      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
